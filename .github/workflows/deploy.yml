name: deploy

permissions:
  contents: write   # allow tag creation/push
  actions: read
  checks: read

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  verify-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need full history to create/move tags
      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - run: npm ci
      - name: Verify production flags (simulated)
        env:
          ENFORCEHTTPS: 'true'
          CSPSTRICT: 'true'
          PRINT_SECRET_FINGERPRINTS: 'false'
          HSTSENABLED: 'true'
          CSRFPROTECTION_ENABLED: 'true'
          SECURITYHEADERSENABLED: 'true'
          DATABASE_URL: 'postgres://placeholder'
        run: node scripts/verify-prod-flags.js
      - name: Tag version
        if: github.ref == 'refs/heads/main'
        run: |
          VERSION=1.0.0-diyartec
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Ensure tag reflects current commit (force-update if already exists)
          git tag -f "$VERSION" || true
          git push --force origin "$VERSION"
      # - name: Deploy API Service (optional Render deploy via action)
      #   uses: JorgeLNJunior/render-deploy@v1.4.5
      #   with:
      #     service_id: ${{ secrets.RENDER_SERVICE_ID_API }}
      #     api_key: ${{ secrets.RENDER_API_KEY }}
      #     wait_deploy: true
      #     github_deployment: true
      #     deployment_environment: production
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
